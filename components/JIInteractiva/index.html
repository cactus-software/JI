<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JI Digital - Verificaci√≥n de Molde</title>
    <style>
        /* Previous CSS remains the same */
        /* Adding camera-related styles */
        .camera-container {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            text-align: center;
        }

        #video {
            width: 100%;
            max-width: 640px;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .camera-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .captured-image {
            width: 100%;
            max-width: 640px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        #capturadas {
            margin-top: 2rem;
        }

        .foto-item {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--color-light);
            border-radius: 8px;
        }

        .imagen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* Previous CSS continues... */
    </style>
</head>
<body>
    <!-- Previous HTML structure remains -->
    
    <!-- Add camera modal -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <button class="modal-close" onclick="cerrarCamara()">√ó</button>
            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div class="camera-buttons">
                    <button class="btn btn-primary" onclick="tomarFoto()">üì∏ Capturar</button>
                    <button class="btn btn-danger" onclick="cerrarCamara()">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Previous JavaScript code remains
        // Add camera-related functions
        let stream = null;
        let capturedImages = {};

        function iniciarCamara(componenteId, verificacionId) {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(videoStream => {
                    stream = videoStream;
                    video.srcObject = stream;
                    modal.classList.add('active');
                    // Store current context for later use
                    window.currentComponenteId = componenteId;
                    window.currentVerificacionId = verificacionId;
                })
                .catch(error => {
                    console.error('Error accessing camera:', error);
                    alert('Error al acceder a la c√°mara. Verifica los permisos.');
                });
        }

        function cerrarCamara() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            modal.classList.remove('active');
        }

        function tomarFoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            // Set canvas size to match video dimensions
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            context.drawImage(video, 0, 0);

            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg');

            // Get current verification context
            const componenteId = window.currentComponenteId;
            const verificacionId = window.currentVerificacionId;

            // Initialize array for this verification if doesn't exist
            if (!capturedImages[verificacionId]) {
                capturedImages[verificacionId] = [];
            }

            // Add timestamp and image data
            capturedImages[verificacionId].push({
                timestamp: new Date().toISOString(),
                imageData: imageData
            });

            // Close camera
            cerrarCamara();
            
            // Update UI
            renderizarApp();
        }

        // Modify renderizarBotones to include camera button and captured images
        function renderizarBotones(componenteId, verificacion) {
            let html = '';
            
            if (!verificacion.inicio) {
                html += `
                    <button class="btn btn-primary" onclick="iniciarVerificacion(${componenteId}, '${verificacion.id}')">
                        ‚è±Ô∏è Iniciar Verificaci√≥n
                    </button>`;
            } else if (!verificacion.fin) {
                html += `
                    <button class="btn btn-primary" onclick="iniciarCamara(${componenteId}, '${verificacion.id}')">
                        üì∏ Tomar Foto
                    </button>
                    <button class="btn btn-success" onclick="completarVerificacion(${componenteId}, '${verificacion.id}', true)">
                        ‚úÖ Completar Verificaci√≥n
                    </button>
                    <button class="btn btn-danger" onclick="noCompletarVerificacion(${componenteId}, '${verificacion.id}')">
                        ‚ùå No se Pudo Completar
                    </button>`;
            }

            // Add captured images section if any exist
            if (capturedImages[verificacion.id] && capturedImages[verificacion.id].length > 0) {
                html += `
                    <div id="capturadas">
                        <h4>üì∏ Fotos Capturadas</h4>
                        ${capturedImages[verificacion.id].map((img, index) => `
                            <div class="foto-item">
                                <div class="imagen-header">
                                    <span>Foto ${index + 1}</span>
                                    <button class="btn btn-danger" onclick="eliminarFoto('${verificacion.id}', ${index})">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                                <img src="${img.imageData}" class="captured-image" alt="Foto capturada ${index + 1}">
                                <p>Tomada: ${new Date(img.timestamp).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    </div>`;
            }

            if (verificacion.fin) {
                html += `
                    <div class="verificacion-resultado">
                        <h4>Resultado de la Verificaci√≥n</h4>
                        <p>‚è±Ô∏è Duraci√≥n: ${formatearTiempo(calcularDuracion(verificacion.inicio, verificacion.fin))}</p>
                        <p>${verificacion.estado ? '‚úÖ Completado' : '‚ùå No Completado'}</p>
                        ${verificacion.notas ? `<p>üìù Notas: ${verificacion.notas}</p>` : ''}
                    </div>`;
            }

            return html;
        }

        function eliminarFoto(verificacionId, index) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar esta foto?')) {
                capturedImages[verificacionId].splice(index, 1);
                renderizarApp();
            }
        }

        // Previous JavaScript code continues...
   // Estado de la aplicaci√≥n
let estado = {
    expandedStep: null,
    activeCheck: null
};

// Funciones auxiliares
function formatearTiempo(segundos) {
    if (segundos < 60) return `${segundos} segundos`;
    return `${Math.floor(segundos / 60)} minutos ${segundos % 60} segundos`;
}

function calcularDuracion(inicio, fin) {
    if (!inicio || !fin) return null;
    return Math.round((new Date(fin) - new Date(inicio)) / 1000);
}

// Funciones de eventos
function toggleComponente(id) {
    estado.expandedStep = estado.expandedStep === id ? null : id;
    renderizarApp();
}

function iniciarVerificacion(componenteId, verificacionId) {
    const componente = datosJI.find(c => c.id === componenteId);
    const verificacion = componente.verificaciones.find(v => v.id === verificacionId);
    verificacion.inicio = new Date().toISOString();
    estado.activeCheck = verificacionId;
    renderizarApp();
}

function completarVerificacion(componenteId, verificacionId, estado) {
    const componente = datosJI.find(c => c.id === componenteId);
    const verificacion = componente.verificaciones.find(v => v.id === verificacionId);
    verificacion.fin = new Date().toISOString();
    verificacion.estado = estado;
    renderizarApp();
}

function noCompletarVerificacion(componenteId, verificacionId) {
    const notas = prompt("Indica el motivo por el que no se pudo completar:");
    if (notas) {
        const componente = datosJI.find(c => c.id === componenteId);
        const verificacion = componente.verificaciones.find(v => v.id === verificacionId);
        verificacion.fin = new Date().toISOString();
        verificacion.estado = false;
        verificacion.notas = notas;
        renderizarApp();
    }
}

function mostrarImagen(src, titulo, descripcion) {
    const modal = document.getElementById('imageModal');
    const imagen = document.getElementById('modalImage');
    const tituloEl = document.getElementById('modalTitle');
    const descEl = document.getElementById('modalDescription');

    imagen.src = src;
    tituloEl.textContent = titulo;
    descEl.textContent = descripcion;
    modal.classList.add('active');
}

function cerrarModal() {
    document.getElementById('imageModal').classList.remove('active');
}

// Cerrar modal al hacer clic fuera
document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.remove('active');
    }
});

// Renderizar aplicaci√≥n inicial
function renderizarApp() {
    const app = document.getElementById('app');
    app.innerHTML = datosJI.map(renderizarComponente).join('');
}

// Iniciar la aplicaci√≥n
renderizarApp();
</script>
</body>
</html>
